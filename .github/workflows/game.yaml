name: Aether Strike - Game Build & Release

on:
  push:
    branches:
      - dev
    paths:
      - 'games/aether_strike/**'
      - '.github/workflows/game.yaml'
  pull_request:
    paths:
      - 'games/aether_strike/**'
      - '.github/workflows/game.yaml'
  workflow_dispatch:

env:
  GAME_NAME: aether_strike
  GAME_PATH: games/aether_strike
  CARGO_TERM_COLOR: always

jobs:
  build-game:
    name: Build Aether Strike (Release)
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: ğŸ“¦ Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: games/aether_strike
          
      - name: ğŸ”¨ Build Aether Strike (Release)
        working-directory: ${{ env.GAME_PATH }}
        run: |
          cargo build --release --verbose
          echo "Build completed successfully!"

      - name: ğŸ“¦ Prepare Release & Metadata
        id: prepare_release
        working-directory: ${{ env.GAME_PATH }}
        shell: powershell
        run: |
          $exe_path = "target/release/${{ env.GAME_NAME }}.exe"
          $file_size = (Get-Item $exe_path).Length / 1MB
          $size_mb = [math]::Round($file_size, 2)
          $build_date = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
          
          # Set outputs
          echo "exe_size=$size_mb MB" >> $env:GITHUB_OUTPUT
          echo "build_date=$build_date" >> $env:GITHUB_OUTPUT
          echo "build_date=$build_date" >> $env:GITHUB_OUTPUT
          
          # Dist folder
          if (Test-Path "dist") { Remove-Item "dist" -Recurse -Force }
          New-Item -ItemType Directory -Force -Path "dist/assets" | Out-Null
          
          # Copy Exe
          Copy-Item $exe_path -Destination "dist/"
          
          # Copy Config
          if (Test-Path "server_config.txt") {
              Copy-Item "server_config.txt" -Destination "dist/"
          } else {
              Write-Warning "server_config.txt not found!"
          }
          
          # Copy Assets
          if (Test-Path "assets") {
              Copy-Item -Path "assets/*" -Destination "dist/assets" -Recurse
              if (-not (Test-Path "dist/assets/characters.png")) {
                  Write-Error "âŒ Critical: missing assets!"
                  exit 1
              }
          }
          
          # Metadata
          $short_sha = "${{ github.sha }}".Substring(0, 7)
          $metadata = @{
            name = "Aether Strike"
            version = "0.1.0-$short_sha"
            executable = "${{ env.GAME_NAME }}.exe"
            description = "RPG Stick War - Turn-based combat game"
            size_mb = "$size_mb MB"
            build_date = $build_date
            commit = "${{ github.sha }}"
            platform = "windows"
            architecture = "x64"
            download_url = "https://github.com/Ryan-DPC/Vext-platform/releases/download/dev-latest/${{ env.GAME_NAME }}_v0.1.0_windows_x64.zip"
            update_url = "https://api.github.com/repos/Ryan-DPC/Vext-platform/releases/tags/dev-latest"
            requires = @{ os = "Windows 10+"; ram_mb = 512; disk_mb = 100 }
            launch_args = @("--vext-token {token}", "--vext-user-id {user_id}", "--vext-server {server_url}", "--fullscreen")
            save_data_path = "%APPDATA%/AetherStrike"
          }
          $metadata | ConvertTo-Json -Depth 10 | Out-File -FilePath "dist/game_metadata.json" -Encoding utf8
          
          # Validate
          if (-not (Test-Path "dist/${{ env.GAME_NAME }}.exe")) { throw "Executable missing" }
          
          # Zip Archive
          $archive_name = "${{ env.GAME_NAME }}_v0.1.0_windows_x64.zip"
          Compress-Archive -Path "dist/*" -DestinationPath $archive_name -Force
          echo "archive_name=$archive_name" >> $env:GITHUB_ENV

      - name: ğŸ“¤ Upload game artifact (for VEXT)
        uses: actions/upload-artifact@v4
        with:
          name: aether_strike_release_${{ github.sha }}
          path: ${{ env.GAME_PATH }}/dist/
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ“¤ Upload release archive
        uses: actions/upload-artifact@v4
        with:
          name: aether_strike_archive
          path: ${{ env.GAME_PATH }}/${{ env.archive_name }}
          retention-days: 90

      - name: ğŸ“Š Build summary
        shell: powershell
        run: |
          @'
          ## ğŸ® Aether Strike Build Summary
          
          | Property | Value |
          |----------|-------|
          | **Game** | Aether Strike |
          | **Version** | 0.1.0 |
          | **Platform** | Windows x64 |
          | **Size** | ${{ steps.prepare_release.outputs.exe_size }} |
          | **Build Date** | ${{ steps.prepare_release.outputs.build_date }} |
          | **Commit** | ${{ github.sha }} |
          
          ### ğŸ“¥ Downloads
          - Game files: `aether_strike_release_${{ github.sha }}`
          - Archive: `aether_strike_archive`
          '@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

  create-release:
    name: Create/Update Dev Release
    needs: build-game
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: aether_strike_archive
          path: ./release

      - name: ğŸ·ï¸ Update Dev Release
        uses: softprops/action-gh-release@v1
        with:
          name: Aether Strike - Dev Build (${{ github.sha }})
          tag_name: dev-latest
          files: ./release/*.zip
          draft: false
          prerelease: true
          generate_release_notes: true
